import DashboardService from "../services/dashboard-service.js";
import AccessController from "./access-controller.js";
import PDFDocument from "pdfkit";
import { posthog } from "../config/posthog.js";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

class DashboardController {

  // ðŸ“Œ GET DASHBOARD STATS
  static async getStats(req, res) {
    try {
      const stats = await DashboardService.getStats();

      posthog.capture({
        distinctId: "backend",
        event: "dashboard_stats_fetched",
        properties: stats
      });

      return AccessController.send(res, 200, "Dashboard stats fetched", stats);

    } catch (err) {
      posthog.capture({
        distinctId: "backend",
        event: "dashboard_stats_failed",
        properties: { error: err.message }
      });

      return AccessController.send(res, 500, err.message);
    }
  }

  // ðŸ“Œ GENERATE REPORT
  static async generateReport(req, res) {
    try {
      posthog.capture({
        distinctId: "backend",
        event: "report_generation_started"
      });

      const rows = await DashboardService.getReportData();

      posthog.capture({
        distinctId: "backend",
        event: "report_data_fetched",
        properties: { rows: rows.length }
      });

      // ========== PDF SETUP ==========
      const doc = new PDFDocument({ margin: 40 });

      res.setHeader("Content-Type", "application/pdf");
      res.setHeader("Content-Disposition", "inline; filename=employee-report.pdf");

      doc.pipe(res);

      // ===== HEADER =====
      doc.rect(0, 0, doc.page.width, 70).fill("#0b3c6f");
      doc.fill("#fff").fontSize(26).font("Helvetica-Bold").text("StaffX (Employee Report)", 40, 22);

      doc.moveDown(2);

      const COL_NAME = 40;
      const COL_EMAIL = 170;
      const COL_CONTACT = 305;
      const COL_DEPT = 395;
      const COL_DESIG = 500;

      const startY = 110;

      // ===== TABLE HEADER =====
      doc.font("Helvetica-Bold").fontSize(13).fill("#000");

      doc.text("Name", COL_NAME, startY);
      doc.text("Email", COL_EMAIL, startY);
      doc.text("Contact", COL_CONTACT, startY);
      doc.fontSize(10);
      doc.text("Department", COL_DEPT, startY);
      doc.text("Designation", COL_DESIG, startY);

      doc.moveTo(40, startY + 18)
        .lineTo(doc.page.width - 40, startY + 18)
        .stroke("#ccc");

      // ===== TABLE ROWS =====
      let y = startY + 30;
      doc.font("Helvetica").fontSize(11);

      rows.forEach((e, idx) => {
        if (idx % 2 === 0) {
          doc.rect(30, y - 8, doc.page.width - 60, 38).fill("#f6f8fa").fillColor("#000");
        }

        doc.fillColor("#000");

        doc.text(e.name, COL_NAME, y);
        doc.text(e.email, COL_EMAIL, y);
        doc.text(e.contact, COL_CONTACT, y);
        doc.text(e.department_name, COL_DEPT, y);
        doc.text(e.designation_name, COL_DESIG, y);

        y += 40;

        if (y > doc.page.height - 100) {
          doc.addPage();
          y = 60;

          doc.font("Helvetica-Bold").fontSize(12);
          doc.text("Name", COL_NAME, y);
          doc.text("Email", COL_EMAIL, y);
          doc.text("Contact", COL_CONTACT, y);
          doc.fontSize(10);
          doc.text("Department", COL_DEPT, y);
          doc.text("Designation", COL_DESIG, y);

          doc.moveTo(40, y + 18)
            .lineTo(doc.page.width - 40, y + 18)
            .stroke("#ccc");

          y += 30;
        }
      });

      // ===== FOOTER =====
      const footerY = doc.page.height - 40;

      doc.moveTo(40, footerY)
        .lineTo(doc.page.width - 40, footerY)
        .stroke("#ccc");

      doc.fontSize(10)
        .fill("#666")
        .text("Generated by StaffX (Employee Management System)", doc.page.width - 280, footerY + 10, {
          lineBreak: false
        });

      doc.end();

      posthog.capture({
        distinctId: "backend",
        event: "report_generated_successfully",
        properties: { rows: rows.length }
      });

    } catch (err) {
      posthog.capture({
        distinctId: "backend",
        event: "report_generation_failed",
        properties: { error: err.message }
      });

      return AccessController.send(res, 500, err.message);
    }
  }
}

export default DashboardController;
